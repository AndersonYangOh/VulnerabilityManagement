/**
 * @author wangjian
 * @date 2016/9/1.
 */

var data = {
    closeDialog: function () {
        $("#autoSelect").hide();
        $(".ejectBg").hide();
    },
    taskId: $.cookie('clickId'),
    queryInterval: undefined,
    isRun: false
}

$(function () {
    //open dialog
    $("#btnAutoSelect").on("click", function () {
        var div = $("#autoSelect");
        var width = div.width();
        var height = div.height();
        common.center(width, height, "#autoSelect");
    });

    //close dialog
    $("#btnCancelAutoSelect").on("click", data.closeDialog);
    $("#singCancelAutoSelect").on("click", data.closeDialog);

    //submit action
    $("#btnSubmitAutoSelect").on("click", function () {
        var createNewTask = $("input[name='createNewTask']:checked").val(); 
		//判断目标任务分组中是否存在资产漏洞数据
		 $.ajax({
	    method: "POST",
        dataType: "json",            
        url: "../assetsAutoSelect/autoSelectcheckTaskData.do",
        data: {
            createNewTask: createNewTask,
            fromTaskId: Cookies.get("clickId")
        },
        async: false     
       }).done(function(msg) {         
            if(msg.code==0){
                if(msg.content == "yes"){
             	    //目标分组存在资产漏洞数据时提示
             	    var width = $(window.parent.document).find(".autoSelectAssetMgs").width();
					var height = $(window.parent.document).find(".autoSelectAssetMgs").height();
					common2.center2(width, height, ".autoSelectAssetMgs");
               }else{
            	   //当自动隶属目标任务中不存在数据时，直接执行后续方法
            	   autuSelectAsset();
               }                               
           }
               }).fail(function(msg){
           console.log(msg.responseText);
       }); 
    });

    $.ajax({
        method: "GET",
        url: "../assetsAutoSelect/hasSelectedAssets.do",
        data: {fromGroupId: Cookies.get("clickId")}
    }).done(function (response) {
        if (response && response.code == 0) {
            if (response.content) {
                var el = $("#btnAutoSelect");
                el.show();
            }
        }
    }).fail(function (response) {
        console.log(response.innerHTML);
    });

    data.queryInterval = setInterval(function () {
        queryTaskProgress();
    }, 500);
});


//自动隶属方法
function autuSelectAsset(){
	layer.load(2);
    var createNewTask = $("input[name='createNewTask']:checked").val();
    var overwrite = false;
	$.ajax({
	    method: "POST",
	    url: "../assetsAutoSelect/autoSelect.do",
	    datatype: "json",
	    data: {
	        createNewTask: createNewTask,
	        overwrite: overwrite,
	        fromTaskId: Cookies.get("clickId")
	    }//,
		//async: false     
	}).done(function (response) {
	    if (response && response.code != null && response.code == 0) {
	        responseData = response.content;
	        data.closeDialog();	 
	    	layer.alert('操作成功', {}, function(){	    			   
	    			window.location.reload();
	    		});	        
	    }else if (response && response.message){
	    	data.closeDialog();
	    	layer.alert(response.message);
	    	layer.closeAll('loading');}
	}).fail(function (response) {
	    console.log(response.responseText);
	});
}


//资产漏洞数据时提示-确认
function confAutoSelectAsset(){
	$(window.parent.document).find(".autoSelectAssetMgs").hide();
	$(window.parent.document).find(".ejectBg2").hide();
	autuSelectAsset();	
}	

function queryTaskProgress() {
    $.ajax({
        method: "GET",
        url: "../utility/getuploadprogress.do",
        data: {taskId: data.taskId}
    }).done(function (response) {
        if (response && response.code == 0) {
            //var complete = true;
            var fileProgress = response.content.fileProgress;
            var taskProgress = response.content.taskProgress;
            for (var i = 0; i < fileProgress.length; i++) {
                var item = fileProgress[i];
                //var fileId = ;
                //console.log(item.message);
                //var elId = "#upload_flaw_file" + fileId;
                if (item.percent == 0) {
                    $("#" + item.id).text(item.message);
                    $("#" + item.id + "percent").text("");
                    $("#" + item.id + "tail").text("");
                    data.isRun = true;
                }
                else {
                    $("#" + item.id).text(item.message + "(");
                    $("#" + item.id + "percent").text(item.percent + "%");
                    if (item.percent == 100) {
                        $("#" + item.id + "percent").css("background-color", "green").css("color", "white");
                    } else {
                        $("#" + item.id + "percent").css("background-color", "white").css("color", "black");
                        data.isRun = true;
                    }
                    $("#" + item.id + "tail").text(")")
                }

                //if(item.percent!=100)complete=false;
            }
            //$("#refreshProgress").show();
            if (taskProgress.fileCount == 0 && taskProgress.percent == 100) {
                clearInterval(data.queryInterval);
                if (data.isRun)location.reload();
            }
        }
        else {
            clearInterval(data.queryInterval);
            console.log("no task running")
        }
    }).fail(function (response) {
        console.log(response.innerHTML);
        clearInterval(data.queryInterval);
    });
}
