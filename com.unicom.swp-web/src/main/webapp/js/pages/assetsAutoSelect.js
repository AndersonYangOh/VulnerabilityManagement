$(function(){
	//初始化数据
	getData();
	buildTree();

	$(".editMoneyCannle").on("click", closePopup);

	//selectGroup();
});

//region ----- 报表查询 -----
var selectedIds; //数据id
var refresh=false; //false: 第一次查询, true:只需更新jqgrid

/*查询自动隶属数据*/
function getData() {
	var responseData;
	$.ajax({
			method: "POST",
			url: "../assetsAutoSelect/getSelectedAssets.do",
			datatype: "json",
			data: {
				assetName: $("#assetName").val(),
				toGroupId: $("#toGroupId").val(),
				fromGroupId: Cookies.get("clickId")
			}
		}).done(function (response) {
			if(response && response.code!=null && response.code==0){
				responseData = response.content;
				fillData(responseData);
			}
		else if(response && response.content)
				console.log(response.content);
		}).fail(function(response){
		console.log(response.responseText);
	});
}

function fillData(responseData) {
	var container = $("#assetListInfo");
	if(refresh){
		container.jqGrid('clearGridData')
			.jqGrid("setGridParam",{
				datatype:"local",
				data:responseData
			})
			.trigger("reloadGrid");
	}else {
		refresh=true;
		container.jqGrid({
			data: responseData,
			datatype: "local",
			/* height : "250", // 表格宽度*/
			autowidth: true, // 是否自动调整宽度
			colNames: ["", "", "", "资产名称", "源分组", "目标分组"],
			colModel: [
				{name: "id", width: '0', key: true, align: 'center', hidden: true},
				{name: "fromGroupId", width: '0', key: false, align: 'center', hidden: true},
				{name: "toGroupId", width: '0', key: false, align: 'center', hidden: true},
				{name: "name", width: '30', align: 'center'},
				{name: "fromGroupName", width: '30', align: 'center'},
				{name: "toGroupName", width: '30', align: 'center'}
			],
			pager: "#assetListInfopager",
			rownumbers: true,
			rowNum: 50,
			rowList: [50, 100, 500],
			sortable: true,
			viewrecords: true,
			gridview: true,
			autoencode: true,
			width: "1041",
			autowidth: true,
			shrinkToFit: true,
			multiselect: true,
			gridComplete: function () {
				$("#delAsset").removeClass("undanger");
				changeGridOptions($("#assetListInfo"), $("#assetListInfopager")); //给分页加全部
			}
		});
	}
}

function deleteAssets() {

	selectedIds = jQuery("#assetListInfo").jqGrid("getGridParam", "selarrrow")
	if(selectedIds && selectedIds.length>0){
		var cf = confirm("确认删除吗？");
		if(!cf) return;
		$.ajax({
			method: "POST",
			url: "../assetsAutoSelect/deleteSelectedAssets.do",
			datatype: "json",
			data: JSON.stringify(selectedIds),
			headers: {
				'Content-Type': 'application/json'
			},
		}).done(function (response) {
			if(response && response.code!=null && response.code==0){
				alert(response.message);
				getData(true);
			}
			else if(response && response.content)
				console.log(response.message);
		}).fail(function(response){
			console.log(response.responseText);
		});
	}else{
		alert("请选择数据！");
	}
}

function resetForm(){
	$("#assetName").val('');
	$("#toGroupId").val('');
	$("#toGroupName").val('');
}

//endregion

//region ----- 选择目标任务组 -----
//弹出窗口
function openPopup() {
	$(".editMoney").show();
	$(".ejectBg").show();
}

function closePopup() {
	$(".editMoney").hide();
	$(".ejectBg").hide();
}

function buildTree(){
	$.ajax({
		method: "POST",
		url: "../assetsAutoSelect/getLeafGroupTree.do",
		datatype: "json"
	}).done(function (response) {
		if(response && response.code!=null && response.code==0){
			fillTree(response.content);
		}
		else if(response && response.content)
			console.log(response.content);
	}).fail(function(response){
		console.log(response.responseText);
	});
}

function fillTree(json){
	var setting = {
		view: {
			dblClickExpand: false,
			selectedMulti: false
		},
		data: {
			simpleData: {
				enable: true
			}
		},
		callback: {
			onClick: onClick

		}
	};
	$.fn.zTree.init($("#tree2"), setting, json);

	//高亮显示当前节点
	var zTree = $.fn.zTree.getZTreeObj("tree2");
}


function onClick(e, treeId, treeNode) {
	$("#toGroupName").val(treeNode.name);
	$("#toGroupId").val(treeNode.id);
	closePopup();
}

function hideMenu() {
	$("#menuContent").fadeOut("fast");
	$("#urlInfoSave").show();
	$("body").unbind("mousedown", onBodyDown);
}
function onBodyDown(event) {
	if (!(event.target.id == "menuBtn" || event.target.id == "menuContent" || $(event.target).parents("#menuContent").length > 0)) {
		hideMenu();
	}
}
//endregion