function parseDate(timestamp) {
	if (timestamp == undefined)return "";
	var date = new Date(timestamp);
	var months = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'];
	var year = date.getFullYear();
	var month = months[date.getMonth()];
	var date = date.getDate();
	var time = year + '-' + month + '-' + date;
	return time;
}

function getVersion() {
	$.ajax({url: "version.do?upgradeType="+$("input[name='upgradeType']:checked").val(),
			datatype: "json",})
		.done(function (e) {
			if (e.content != null) {
				$('#version').text(e.content.version);
				$('#upgrade-date').text(moment(e.content.createTime).format("YYYY-MM-DD HH:mm:ss"));
			}else{
				$('#version').text("");
				$('#upgrade-date').text("");
			}
		}).fail(function (e) {
		console.log(e);
	});
}


//实例化一个plupload上传对象
var uploader = new plupload.Uploader({ // 实例化一个plupload上传对象
	browse_button: 'browse',
	url: 'uploadData.do',
	flash_swf_url: 'js/pupload/Moxie.swf',
	silverlight_xap_url: 'js/pupload/Moxie.xap',
	filters: [{
		title: "bin升级文件",
		extensions: "bin"
	}],
	max_file_size: '2000mb',
	prevent_duplicates: true
});
$(function(){
	uploader.init(); // 初始化
	getVersion();

	$("#upgradeSys").click(function(){getVersion()});
	$("#upgradeFlaw").click(function(){getVersion()});

});


var interval;
// 绑定文件添加进队列事件
uploader.bind('FilesAdded', function (uploader, files) {
	if (files.length > 1)
		files.shift();

	// 构造html来更新UI
	var html = '<li id="file-' + files[0].id + '"><p class="file-name">'
		+ files[0].name + '</p><p class="progress"></p></li>';
	$("#file-list").empty();
	$(html).appendTo('#file-list');
	uploader.start();
	queryProgress();
});

// 绑定文件上传进度事件
uploader.bind('UploadProgress', function (uploader, file) {
	$('#file-' + file.id + ' .progress').css('width', file.percent + '%');// 控制进度条
});

// 上传按钮
$('#upload-btn').click(function () {
	uploader.start(); // 开始上传
});

function queryProgress() {

	$.ajax({
		url: '../utility/getprogress.do?progressId=system_upgrade_progress_key',
		type: 'GET'
	}).done(function (e) {
		if (e.message == null)e.message = "";

		/*$('#progress').animate({'opacity': 0}, 50, function () {
		 $(this).text(e.message);
		 }).animate({'opacity': 1}, 500);*/

		$("#progress").text(e.message);
		if (e.content==100 || e.code != 0) {
			getVersion();
			$.ajax({
				url:'../utility/clearprogress.do?progressId=system_upgrade_progress_key',
				type:'GET'
			});
		}else{
            setTimeout("queryProgress()", 300);
        }
	}).fail(function (e) {
		console.log(e);
	})
}

$("#testupgrade").click(function () {
	$.ajax({
		url: 'testUpgrade.do',
		type: 'GET'
	}).done(function (e) {
		$('#upgradeversion').text(e);
	}).fail(function (e) {
		console.log(e);
	})
})

$("#updateFlaw").click(function () {
	$.ajax({
		url: 'updateUnknownFlaws.do',
		type: 'GET'
	}).done(function (e) {
		$("#progress").text(e.message);
	}).fail(function (e) {
		console.log(e);
	})
})

function refreshDongle(){
    $.ajax({
        url: '/refreshdongle.do',
        type: 'PATCH'
    }).done(function (e) {
        if (e.code == 0) {
            $("#refresh-dongle").text("重新读取授权信息成功，请手动刷新页面！");
        }else{
            $("#refresh-dongle").text("读取授权信息失败！");
        }
    }).fail(function (e) {
        console.log(e);
    })
}


