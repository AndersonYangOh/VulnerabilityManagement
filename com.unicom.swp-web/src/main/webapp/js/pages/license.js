//实例化一个plupload上传对象
var uploader = new plupload.Uploader({ // 实例化一个plupload上传对象
	browse_button: 'browse',
	url: '/upgradelicense.do',
	flash_swf_url: 'js/pupload/Moxie.swf',
	silverlight_xap_url: 'js/pupload/Moxie.xap',
	filters: [{
		title: "bin升级文件",
		extensions: "bin"
	}],
	max_file_size: '2000mb',
	prevent_duplicates: true
});
$(function(){
	uploader.init(); // 初始化

});


var interval;
// 绑定文件添加进队列事件
uploader.bind('FilesAdded', function (uploader, files) {
	if (files.length > 1)
		files.shift();

	// 构造html来更新UI
	var html = '<li id="file-' + files[0].id + '"><p class="file-name">'
		+ files[0].name + '</p><p class="progress"></p></li>';
	$("#file-list").empty();
	$(html).appendTo('#file-list');
	uploader.start();
	queryProgress();
});

// 绑定文件上传进度事件
uploader.bind('UploadProgress', function (uploader, file) {
	$('#file-' + file.id + ' .progress').css('width', file.percent + '%');// 控制进度条
});

// 上传按钮
$('#upload-btn').click(function () {
	uploader.start(); // 开始上传
});

function queryProgress() {

	$.ajax({
		url: '../utility/getprogress.do?progressId=system_upgrade_progress_key',
		type: 'GET'
	}).done(function (e) {
		if (e.message == null)e.message = "";

		/*$('#progress').animate({'opacity': 0}, 50, function () {
		 $(this).text(e.message);
		 }).animate({'opacity': 1}, 500);*/

		$("#progress").text(e.message);
		if (e.content==100 || e.code != 0) {
			getVersion();
			$.ajax({
				url:'../utility/clearprogress.do?progressId=system_upgrade_progress_key',
				type:'GET'
			});
		}else{
            setTimeout("queryProgress()", 300);
        }
	}).fail(function (e) {
		console.log(e);
	})
}


