 param (
    [string]$env="dev",    
    [string]$workingDir,
    [string]$buildName
 )

#region proguard
if($env -ne "dev")
{
    & cd $workingDir
    $newFile = "classes-pg"
    If (Test-Path -path $newFile){
    	Remove-Item -path $newFile -Recurse -Force  
    }   
    $newFile += ".jar"
    Write-Host "----- Unzip -----"
    & "C:\Program Files\7-Zip\7z.exe" x $newFile -o*

    Write-Host "----- Encryptor Class -----"
    Write-Host "- encrypt zz"
    & java.exe -cp ..\..\..\tools\VulinsightLib\shiro-tool-1.0-SNAPSHOT.jar com.icgrtech.vulinsight.loader.ClassEncyptor ..\..\key.data classes-pg\com\bat\swp\web\exclude\zz1.class
    & java.exe -cp ..\..\..\tools\VulinsightLib\shiro-tool-1.0-SNAPSHOT.jar com.icgrtech.vulinsight.loader.ClassEncyptor ..\..\key.data classes\com\bat\swp\web\exclude\zz1.class
    Write-Host "- sign zz.class -"
    & java.exe -cp "..\..\..\tools\VulinsightLib\shiro-tool-1.0-SNAPSHOT.jar;classes-pg" com.icgrtech.signature.ClassSigner com/bat/swp/web/utils/zz.class classes-pg/app-code-config.xml 0
    & java.exe -cp "..\..\..\tools\VulinsightLib\shiro-tool-1.0-SNAPSHOT.jar;classes" com.icgrtech.signature.ClassSigner com/bat/swp/web/utils/zz.class classes/app-code-config.xml 0

    Write-Host "- sign BeanDefineConfigue.class -"
    & java.exe -cp "..\..\..\tools\VulinsightLib\shiro-tool-1.0-SNAPSHOT.jar;classes-pg" com.icgrtech.signature.ClassSigner com/bat/swp/web/controller/BeanDefineConfigue.class classes-pg/app-code-config.xml 1
    & java.exe -cp "..\..\..\tools\VulinsightLib\shiro-tool-1.0-SNAPSHOT.jar;classes" com.icgrtech.signature.ClassSigner com/bat/swp/web/controller/BeanDefineConfigue.class classes/app-code-config.xml 1

    $buildClassPath = $buildName+"\WEB-INF\classes"
    Remove-Item -path  $buildClassPath -Recurse -Force
    Write-Host "buildClassPath: $buildClassPath"

    Copy-Item classes-pg -Destination "$buildClassPath\" -Recurse -Force
    #& xcopy /s /i /y classes-pg\*.* $buildClassPath 

    Write-Host "- build war file -"
    & del ROOT.war
    Set-Location $buildName
    & jar.exe cf ROOT.war .
    & move ROOT.war ..\
    Set-Location ..
}
#endregion